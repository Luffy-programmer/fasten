CREATE OR REPLACE PROCEDURE is_vulnerable(
    pkg_name TEXT,
    pkg_version TEXT)
LANGUAGE plpgsql
AS $$
DECLARE
    vul_row callables%ROWTYPE;
    counter integer := 0;
BEGIN
    FOR vul_row IN 
        SELECT c3.id, c3.module_id, c3.fasten_uri, c3.is_internal_call, c3.created_at, c3.metadata
        FROM callables AS c1
        JOIN modules ON c1.module_id = modules.id
        JOIN package_versions ON package_versions.id = modules.package_version_id
        JOIN packages ON packages.id = package_versions.package_id
        JOIN edges ON edges.source_id = c1.id
        JOIN callables AS c2 ON c2.id = edges.target_id
        JOIN callables AS c3 ON c3.fasten_uri = c2.fasten_uri
        JOIN modules AS m2 ON m2.id = c3.module_id
        JOIN (
            SELECT modules.id
            FROM packages
            JOIN package_versions ON package_versions.package_id = packages.id
            JOIN (
                SELECT packages.package_name, dep.version_range
                FROM dependencies AS dep
                JOIN packages ON packages.id = dep.dependency_id
                WHERE package_version_id = (
                    SELECT package_versions.id
                    FROM package_versions
                    JOIN packages ON packages.id = package_versions.package_id
                    WHERE packages.package_name = pkg_name
                    AND package_versions.version = pkg_version
                    )
                ) dep_packages ON (dep_packages.package_name = packages.package_name AND package_versions.version = ANY(dep_packages.version_range))
                JOIN modules ON package_versions.id = modules.package_version_id
            ) dep_modules ON dep_modules.id = m2.id
        WHERE packages.package_name = pkg_name
        AND package_versions.version = pkg_version
        AND c1.is_internal_call = 't' 
        AND c2.is_internal_call = 'f'
        AND c3.is_internal_call = 't'
        AND c3.metadata -> 'vulnerabilities' IS NOT NULL
    LOOP
        counter := counter + 1;
        IF counter = 1 THEN
        RAISE INFO '! -- ALERT --!';
        END IF;
        -- Print information about the vulnerability
        -- TODO: Each metadata -> vulnerabilities might contain more than 1 vulnerability
        RAISE INFO 'Found vulnerablitiy % in callable with ID: % and fasten_uri: %', 
            vul_row.metadata -> 'vulnerabilities' -> 0 -> 'id',
            vul_row.id,
            vul_row.fasten_uri;
        END LOOP;
    -- Print information
    IF counter = 0 THEN
        RAISE INFO 'o -- SAFE -- o';
    END IF;
END;
$$;
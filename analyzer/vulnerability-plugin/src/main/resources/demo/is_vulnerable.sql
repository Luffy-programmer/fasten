CREATE OR REPLACE PROCEDURE is_vulnerable(
    pkg_name TEXT,
    pkg_version TEXT)
LANGUAGE plpgsql
AS $$
DECLARE
    vulnerable_callable_ids INTEGER;
    vulnerability_ids TEXT;
BEGIN
    SELECT INTO vulnerable_callable_ids, vulnerability_ids c3.id, c3.metadata -> 'vulnerabilities' -> 0 -> 'id'
    FROM callables AS c1
    JOIN modules ON c1.module_id = modules.id
    JOIN package_versions ON package_versions.id = modules.package_version_id
    JOIN packages ON packages.id = package_versions.package_id
    JOIN edges ON edges.source_id = c1.id
    JOIN callables AS c2 ON c2.id = edges.target_id
    JOIN callables AS c3 ON c3.fasten_uri = c2.fasten_uri
    JOIN modules AS m2 ON m2.id = c3.module_id
    JOIN (
        SELECT modules.id
        FROM packages
        JOIN package_versions ON package_versions.package_id = packages.id
        JOIN (
            SELECT packages.package_name, dep.version_range
            FROM dependencies AS dep
            JOIN packages ON packages.id = dep.dependency_id
            WHERE package_version_id = (
                SELECT package_versions.id
                FROM package_versions
                JOIN packages ON packages.id = package_versions.package_id
                WHERE packages.package_name = pkg_name
                AND package_versions.version = pkg_version
                )
            ) dep_packages ON (dep_packages.package_name = packages.package_name AND package_versions.version = ANY(dep_packages.version_range))
            JOIN modules ON package_versions.id = modules.package_version_id
        ) dep_modules ON dep_modules.id = m2.id
    WHERE packages.package_name = pkg_name
    AND package_versions.version = pkg_version
    AND c1.is_internal_call = 't' 
    AND c2.is_internal_call = 'f'
    AND c3.is_internal_call = 't'
    AND c3.metadata -> 'vulnerabilities' IS NOT NULL;
    -- Print information
    IF vulnerable_callable_ids IS NOT NULL THEN
        RAISE INFO '! -- ALERT --!';
        RAISE INFO 'Found vulnerablitiy % in callable with ID: %', vulnerability_ids, vulnerable_callable_ids;
    ELSE
        RAISE INFO '√ -- SAFE -- √';
    END IF;
END;
$$;
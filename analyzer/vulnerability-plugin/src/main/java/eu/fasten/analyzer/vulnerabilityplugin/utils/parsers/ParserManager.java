/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package eu.fasten.analyzer.vulnerabilityplugin.utils.parsers;

import com.mongodb.client.MongoDatabase;
import eu.fasten.analyzer.vulnerabilityplugin.db.NitriteController;
import eu.fasten.analyzer.vulnerabilityplugin.utils.PatchFarmer;
import eu.fasten.analyzer.vulnerabilityplugin.utils.Vulnerability;
import eu.fasten.analyzer.vulnerabilityplugin.utils.connections.JavaHttpClient;
import eu.fasten.analyzer.vulnerabilityplugin.utils.mappers.VersionRanger;
import org.jooq.tools.json.JSONParser;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.HashMap;
import java.util.HashSet;
import java.util.Optional;
import java.util.concurrent.TimeUnit;

/**
 * The responsibility of the ParserManager is to gather Vulnerabilities from all the parsers.
 * Combine them together, merging what is necessary and the handing them over to the PatchFarmer to enrich
 * every single vulnerability with information about patches specifically.
 */
public class ParserManager {
    private ExtraParser extraParser;
    private GHParser ghParser;
    private NVDParser nvdParser;
    private PatchFarmer patchFarmer;
    private VersionRanger versionRanger;
    private NitriteController nitriteController;
    private final Logger logger = LoggerFactory.getLogger(ParserManager.class.getName());

    private String pathToVersions = "./analyzer/vulnerability-plugin/src/main/resources/trackers/package_versions.json";
    private String pathToGHCursor = "./analyzer/vulnerability-plugin/src/main/resources/trackers/cursor.txt";

    public ParserManager(JavaHttpClient client,
                         MongoDatabase mongoDatabase,
                         String ghToken,
                         NitriteController nitriteController) {
        this.versionRanger = new VersionRanger(client, pathToVersions);
        this.extraParser = new ExtraParser(client, versionRanger);
        this.ghParser = new GHParser(client, ghToken, versionRanger, pathToGHCursor);
        this.nvdParser = new NVDParser(new JSONParser(), client);
        this.patchFarmer = new PatchFarmer(mongoDatabase, client);
        this.nitriteController = nitriteController;
    }

    /**
     * Combines the results of all the parsers.
     *
     * @return set of vulnerability objects containing all the information found.
     */
    public HashSet<Vulnerability> getVulnerabilitiesFromParsers() {
        HashSet<Vulnerability> vulnerabilities = new HashSet<>();

        logger.info("Gathering vulnerabilities from GitHub Advisories");
        HashMap<String, Vulnerability> mapFromGH = ghParser.getVulnerabilities();
        logger.info("Gathering vulnerabilities from Extra Sources");
        HashMap<String, Vulnerability> mapFromExtraSources = extraParser.getVulnerabilities();
        logger.info("Gathering vulnerabilities from NVD");
        HashMap<String, Vulnerability> mapFromNVD = nvdParser.getVulnerabilities();

        logger.info("Merging all the pulled vulnerabilities");
        mergeVulnerabilitiesFromParsers(mapFromNVD, mapFromGH, mapFromExtraSources, vulnerabilities);

        logger.info("Injecting information about Patches");
        for (Vulnerability v : vulnerabilities) {
            patchFarmer.parseReferences(v, nitriteController);
        }

        filterNewEntries(vulnerabilities);

        return vulnerabilities;
    }

    /**
     * Get updates from all the different parsers and return them.
     *
     * @return set of vulnerabilities, including new ones and changed ones.
     */
    public HashSet<Vulnerability> getUpdatesFromParsers() {
        HashSet<Vulnerability> vulnerabilities = new HashSet<>();
        logger.info("Updating Versions of Packages");
        versionRanger.updateMappings();

        logger.info("Gathering updates from GitHub Advisories");
        HashMap<String, Vulnerability> mapFromGH = ghParser.getUpdates();
        logger.info("Gathering updates from Extra Sources");
        HashMap<String, Vulnerability> mapFromExtraSources = extraParser.getUpdates();
        logger.info("Gathering updates from NVD");
        HashMap<String, Vulnerability> mapFromNVD = nvdParser.getUpdates();

        logger.info("Merging all the pulled updates");
        mergeVulnerabilitiesFromParsers(mapFromNVD, mapFromGH, mapFromExtraSources, vulnerabilities);

        for (Vulnerability v : vulnerabilities) {
            patchFarmer.parseReferences(v, nitriteController);
        }

        filterNewEntries(vulnerabilities);

        return vulnerabilities;
    }

    /**
     * For each of the entries in the set, checks Nitrite for the entry.
     * If the entry is found AND it's equals, it is discarded.
     *
     * @param vulnerabilities - cleaned containing only new ones.
     */
    private void filterNewEntries(HashSet<Vulnerability> vulnerabilities) {
        for (Vulnerability v : vulnerabilities) {
            Optional<Vulnerability> queryFromNC = nitriteController.findVulnerabilityEntry(v.getId());
            if (!queryFromNC.isEmpty()) {
                if (queryFromNC.get().equals(v)) {
                    vulnerabilities.remove(v);
                }
            }
        }
    }

    /**
     * Merges the maps from all the different parsers.
     * Used both in the beginning and for each update
     *
     * @param mapFromNVD          - map of Vulnerabilities from NVD
     * @param mapFromGH           - map of Vulnerabilities from GH
     * @param mapFromExtraSources - map of Vulnerabilities from Extra
     * @param vulnerabilities     - set of vulnerabilities
     */
    public void mergeVulnerabilitiesFromParsers(HashMap<String, Vulnerability> mapFromNVD,
                                                HashMap<String, Vulnerability> mapFromGH,
                                                HashMap<String, Vulnerability> mapFromExtraSources,
                                                HashSet<Vulnerability> vulnerabilities) {
        for (String vId : mapFromNVD.keySet()) {
            Vulnerability v = mapFromNVD.get(vId);
            if (mapFromGH.containsKey(vId)) {
                v.merge(mapFromGH.get(vId));
                mapFromGH.remove(vId);
            }
            if (mapFromExtraSources.containsKey(vId)) {
                v.merge(mapFromExtraSources.get(vId));
                mapFromExtraSources.remove(vId);
            }
            vulnerabilities.add(v);
        }

        for (String vId : mapFromGH.keySet()) {
            Vulnerability v = mapFromGH.get(vId);
            if (mapFromExtraSources.containsKey(vId)) {
                v.merge(mapFromExtraSources.get(vId));
                mapFromExtraSources.remove(vId);
            }
            vulnerabilities.add(v);
        }

        for (String vId : mapFromExtraSources.keySet()) {
            vulnerabilities.add(mapFromExtraSources.get(vId));
        }
    }

    /**
     * Helper function for the vulnerability Plugin to inject the sleep behaviour.
     * This way, when mocking the parser, you can just skip over the wait.
     */
    public void sleep() {
        try {
            TimeUnit.DAYS.sleep(1);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    /**
     * Helper method to inject parsers and test the merging of the three sources.
     *
     * @param nvdParser   - NVDParser
     * @param ghParser    - GHParser
     * @param extraParser - ExtraParser
     * @param patchFarmer - PatchFarmer
     */
    public void injectParsers(NVDParser nvdParser,
                              GHParser ghParser,
                              ExtraParser extraParser,
                              PatchFarmer patchFarmer) {
        this.nvdParser = nvdParser;
        this.ghParser = ghParser;
        this.extraParser = extraParser;
        this.patchFarmer = patchFarmer;
    }
}
